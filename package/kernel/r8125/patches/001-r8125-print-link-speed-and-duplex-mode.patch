From 8b8f6626f0f39b29fc5dc037887bb3a350a8a95b Mon Sep 17 00:00:00 2001
From: Chukun Pan <amadeus@jmu.edu.cn>
Date: Sun, 4 Aug 2024 21:16:23 +0800
Subject: [PATCH] r8125: print link speed and duplex mode
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Like other Ethernet drivers, print link speed and duplex mode
when the interface is up. Formatting output at the same time.

Signed-off-by: Chukun Pan <amadeus@jmu.edu.cn>
Signed-off-by: Álvaro Fernández Rojas <noltari@gmail.com>
---
 src/r8125.h   |  2 ++
 src/r8125_n.c | 16 ++++++++++++++--
 2 files changed, 16 insertions(+), 2 deletions(-)

--- a/src/r8125.h
+++ b/src/r8125.h
@@ -1563,6 +1563,8 @@ enum RTL8125_register_content {
         LinkStatus = 0x02,
         FullDup = 0x01,
 
+#define RTL8125_FULL_DUPLEX_MASK (_2500bpsF | _1000bpsF | FullDup)
+
         /* DBG_reg */
         Fix_Nak_1 = (1 << 4),
         Fix_Nak_2 = (1 << 3),
--- a/src/r8125_n.c
+++ b/src/r8125_n.c
@@ -786,6 +786,14 @@ rtl8125_sysfs_testmode_on(struct rtl8125
 #endif
 }
 
+static char* rtl8125_convert_link_duplex(u16 status)
+{
+        if (status & RTL8125_FULL_DUPLEX_MASK)
+                return "Full";
+        else
+                return "Half";
+}
+
 static u32 rtl8125_convert_link_speed(u16 status)
 {
         u32 speed = SPEED_UNKNOWN;
@@ -5120,11 +5128,16 @@ _rtl8125_check_link_status(struct net_de
         if (tp->link_ok(dev)) {
                 rtl8125_link_on_patch(dev);
 
-                if (netif_msg_ifup(tp))
-                        printk(KERN_INFO PFX "%s: link up\n", dev->name);
+                if (netif_msg_ifup(tp)) {
+                        const u16 status = RTL_R16(tp, PHYstatus);
+                        printk(KERN_INFO PFX "%s: Link is Up - %dMbps/%s\n",
+                               dev->name,
+                               rtl8125_convert_link_speed(status),
+                               rtl8125_convert_link_duplex(status));
+                }
         } else {
                 if (netif_msg_ifdown(tp))
-                        printk(KERN_INFO PFX "%s: link down\n", dev->name);
+                        printk(KERN_INFO PFX "%s: Link is Down\n", dev->name);
 
                 rtl8125_link_down_patch(dev);
         }
